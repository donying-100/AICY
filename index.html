import React, { useState, useEffect, useCallback } from 'react';
import { ThumbsUp, Copy, Bot, User, KeyRound, LoaderCircle } from 'lucide-react';

// Helper to get initial state from localStorage
const getInitialState = (key, defaultValue) => {
  if (typeof window !== 'undefined') {
    const saved = localStorage.getItem(key);
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        return parsed === null ? defaultValue : parsed;
      } catch (e) {
        return defaultValue;
      }
    }
  }
  return defaultValue;
};

// Main App Component
const App = () => {
  // --- STATE MANAGEMENT ---
  // UPDATE: Changed default API key to the new Gemini key
  const [apiKey, setApiKey] = useState(getInitialState('mjby_gemini_apiKey', 'AIzaSyC1KG5U-kWvjO1kM6sv88pUR4FXK19sZlA'));
  const [opponentWords, setOpponentWords] = useState('');
  const [intensity, setIntensity] = useState(5);
  const [responses, setResponses] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [showApiInput, setShowApiInput] = useState(false);

  // --- LOCALSTORAGE PERSISTENCE ---
  useEffect(() => {
    if (typeof window !== 'undefined') {
      // UPDATE: Using a new localStorage key for Gemini
      localStorage.setItem('mjby_gemini_apiKey', JSON.stringify(apiKey));
    }
  }, [apiKey]);

  // --- API CALL LOGIC (UPDATED FOR GEMINI API) ---
  const handleArgue = useCallback(async () => {
    if (!apiKey || apiKey.trim() === '') {
      setError('请先设置一个有效的 Gemini API Key。');
      setShowApiInput(true);
      return;
    }
    
    if (!opponentWords) {
      setError('你总得告诉我对方说了什么吧？');
      return;
    }

    setIsLoading(true);
    setError(null);
    setResponses([]);

    // Construct the prompt for the AI model (still valid for Gemini)
    const prompt = `
      你是一个“吵架王”，一个精通各种言辞艺术的大师。你的任务是根据对方说的话，以1到10的强度进行回击。
      - 强度1-3: 温和、讲道理，但略带讽刺。
      - 强度4-6: 正常反驳，开始使用类比和反问，比较幽默。
      - 强度7-9: 攻击性变强，言辞犀利，直击要害，但不说脏话。
      - 强度10: 火力全开，极具攻击性和压迫感，让对方无言以对。

      当前强度设置为: ${intensity}/10
      对方说的话是: "${opponentWords}"

      请严格按照这个强度，给我生成3个简短、有力、风格各异的回复。每个回复都以"• "开头，并用换行符分隔。
    `;

    // UPDATE: API endpoint and request structure for Gemini
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey.trim()}`;
    
    const requestBody = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }]
    };

    try {
      const response = await fetch(apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(requestBody)
      });

      const data = await response.json();

      if (!response.ok) {
        // Handle Gemini-specific errors
        const errorMessage = data?.error?.message || `API请求失败，状态码: ${response.status}`;
        throw new Error(errorMessage);
      }

      // UPDATE: Parsing logic for Gemini's response structure
      const content = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!content) {
        throw new Error('AI返回了意想不到的数据格式。');
      }
      
      const generatedResponses = content.split('• ').filter(r => r.trim() !== '').map(r => r.trim());
      setResponses(generatedResponses);

    } catch (e) {
      console.error(e);
      setError(e.message || '发生未知错误，请检查网络或API Key。');
      if (e.message.includes('API key not valid')) {
        setShowApiInput(true);
      }
    } finally {
      setIsLoading(false);
    }
  }, [apiKey, opponentWords, intensity]);

  // --- UI HELPER FUNCTIONS ---
  const copyToClipboard = (text) => {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
    }
    document.body.removeChild(textarea);
  };

  // --- RENDER ---
  return (
    <div className="min-h-screen bg-[#F5F5F5] font-sans flex flex-col items-center p-4">
      <div className="w-full max-w-md mx-auto">
        
        <header className="text-center py-4">
          <h1 className="text-3xl font-bold text-[#191919] flex items-center justify-center">
            <Bot className="w-8 h-8 mr-2 text-[#07C160]" />
            妙架包赢
          </h1>
          <p className="text-gray-500 mt-1">输入对方的话，AI助你火力全开 (Gemini版)</p>
        </header>

        <main className="bg-white rounded-lg shadow-md p-6 mt-4">
          
          <div className="mb-6">
            <label htmlFor="opponent-words" className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
              <User className="w-4 h-4 mr-2" />
              对方说了什么？
            </label>
            <textarea
              id="opponent-words"
              value={opponentWords}
              onChange={(e) => setOpponentWords(e.target.value)}
              placeholder="在这里粘贴或输入对方的“典中典”"
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#07C160] focus:border-[#07C160] transition duration-200 resize-none"
              rows="4"
            />
          </div>

          <div className="mb-6">
            <label htmlFor="intensity" className="block text-sm font-medium text-gray-700 mb-2">
              火力强度: <span className="font-bold text-[#07C160]">{intensity}</span> / 10
            </label>
            <input
              id="intensity"
              type="range"
              min="1"
              max="10"
              value={intensity}
              onChange={(e) => setIntensity(Number(e.target.value))}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#07C160]"
            />
          </div>

          <button
            onClick={handleArgue}
            disabled={isLoading}
            className="w-full bg-[#07C160] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#06AD56] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#07C160] transition-all duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            {isLoading ? (
              <>
                <LoaderCircle className="animate-spin w-5 h-5 mr-2" />
                正在组织语言...
              </>
            ) : (
              '开始吵架'
            )}
          </button>
          
          <div className="text-center mt-4">
            <button onClick={() => setShowApiInput(!showApiInput)} className="text-xs text-gray-500 hover:text-gray-700">
              {showApiInput ? '隐藏' : '设置'} API Key
            </button>
          </div>
          
          {showApiInput && (
            <div className="mt-4 p-3 bg-gray-50 rounded-lg">
               <label htmlFor="api-key" className="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                  <KeyRound className="w-4 h-4 mr-2" />
                  {/* UPDATE: Changed label to Gemini */}
                  Google Gemini API Key
                </label>
              <input
                id="api-key"
                type="password"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="AIzaSy..."
                className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#07C160]"
              />
              <p className="text-xs text-gray-500 mt-2">
                {/* UPDATE: Changed link to Google AI Studio */}
                从 <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">Google AI Studio</a> 获取你的免费API Key。
              </p>
            </div>
          )}

        </main>

        {error && (
          <div className="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong className="font-bold">哎呀! </strong>
            <span className="block sm:inline">{error}</span>
          </div>
        )}

        {responses.length > 0 && (
          <div className="mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 className="text-lg font-semibold text-gray-800 mb-4">AI为你生成的回复:</h2>
            <ul className="space-y-4">
              {responses.map((res, index) => (
                <li key={index} className="p-4 bg-gray-50 rounded-lg flex justify-between items-start group">
                  <p className="text-gray-800 flex-1 pr-4">{res}</p>
                  <button 
                    onClick={() => copyToClipboard(res)}
                    className="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-gray-200 hover:bg-[#07C160] hover:text-white text-gray-600 p-2 rounded-full"
                    title="复制"
                  >
                    <Copy className="w-4 h-4" />
                  </button>
                </li>
              ))}
            </ul>
          </div>
        )}
        
        <footer className="text-center py-4 mt-4">
            <p className="text-xs text-gray-400">
                AI生成内容仅供娱乐，请谨慎使用。
            </p>
        </footer>

      </div>
    </div>
  );
};

export default App;
