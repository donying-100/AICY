<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小红书封面生成器 V2.5</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 库用于截图 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 预连接 Google Fonts 以优化加载 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* 自定义样式 */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            overscroll-behavior: none; /* 防止移动端下拉刷新页面 */
        }

        /* 设置画布的宽高比为 3:4 */
        #canvas {
            aspect-ratio: 3 / 4;
        }

        /* 可拖拽图片的样式 */
        .image-container {
            position: relative;
            cursor: grab;
        }
        #image-preview {
            position: absolute;
            user-select: none;
            -webkit-user-drag: none;
        }

        /* --- 模板通用与特定样式 --- */

        /* 模板A: 经典白底 */
        #canvas.template-a { display: flex; flex-direction: column; }
        .template-a .text-container { flex-basis: 45%; background-color: white; padding: 5%; display: flex; flex-direction: column; justify-content: center; }
        .template-a .image-container { flex-basis: 55%; overflow: hidden; }
        .template-a .description-text::before { content: ''; display: inline-block; width: 4px; height: 1em; background-color: #333; margin-right: 0.5rem; vertical-align: middle; }
        .template-a .title-highlight { background: linear-gradient(to top, transparent 10%, #FFDE59 10%, #FFDE59 90%, transparent 90%); padding: 0 0.2em; }

        /* 模板B: 清新绿底 */
        #canvas.template-b { display: flex; flex-direction: column; }
        .template-b .text-container { order: 2; flex-basis: 45%; background-color: #f0fdf4; padding: 5%; display: flex; flex-direction: column; justify-content: center; }
        .template-b .image-container { order: 1; flex-basis: 55%; overflow: hidden; }
        .template-b .description-text::before { content: ''; display: inline-block; width: 4px; height: 1em; background-color: #16a34a; margin-right: 0.5rem; vertical-align: middle; }

        /* 模板C: 文字悬浮 */
        #canvas.template-c { position: relative; }
        .template-c .image-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .template-c .text-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 2; padding: 5%; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(to top, rgba(0,0,0,0.7) 10%, transparent 60%); }
        .template-c .text-container p, .template-c .text-container h1 { color: white; }
        .template-c .description-text::before { background-color: white; }

        /* 模板D: 深色数据 */
        #canvas.template-d { display: flex; flex-direction: column; }
        .template-d .text-container { order: 2; flex-basis: 50%; background-color: #1f2937; padding: 5%; display: flex; flex-direction: column; justify-content: center; }
        .template-d .text-container p, .template-d .text-container h1 { color: white; }
        .template-d .image-container { order: 1; flex-basis: 50%; overflow: hidden; }
        .template-d .aux-text { color: #9ca3af; }
        .template-d .description-text { color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 lg:p-8">
        <div class="flex flex-col lg:flex-row lg:items-start gap-8">
            
            <!-- 控制面板 -->
            <div class="w-full lg:w-1/3 bg-white p-4 rounded-2xl shadow-lg space-y-4 h-fit">
                <h1 class="text-xl font-bold text-center text-gray-800 lg:hidden">小红书封面生成器</h1>
                <!-- 1. 模板选择 -->
                <div>
                    <h2 class="text-lg font-bold mb-2 text-gray-700">1. 选择模板</h2>
                    <div class="grid grid-cols-4 gap-2">
                        <button data-template="template-a" class="template-btn bg-blue-500 text-white rounded-md py-2 px-1 text-xs focus:outline-none font-semibold">经典白底</button>
                        <button data-template="template-b" class="template-btn bg-gray-200 text-gray-700 rounded-md py-2 px-1 text-xs focus:outline-none font-semibold">清新绿底</button>
                        <button data-template="template-c" class="template-btn bg-gray-200 text-gray-700 rounded-md py-2 px-1 text-xs focus:outline-none font-semibold">文字悬浮</button>
                        <button data-template="template-d" class="template-btn bg-gray-200 text-gray-700 rounded-md py-2 px-1 text-xs focus:outline-none font-semibold">深色数据</button>
                    </div>
                </div>

                <!-- 2. 内容编辑 -->
                <div>
                    <h2 class="text-lg font-bold mb-2 text-gray-700">2. 编辑内容</h2>
                    <div class="space-y-3">
                        <!-- 图片上传 -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">更换图片</label>
                            <input type="file" id="image-upload" accept="image/*" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        
                        <!-- 文本编辑模块 -->
                        <div class="border-t pt-3">
                             <p class="text-sm font-semibold text-gray-600 mb-1">引言/LOGO不要可删除</p>
                             <input type="text" id="aux-text-input" value="引言/LOGO" class="w-full border-gray-300 rounded-md shadow-sm text-sm p-2">
                             <div class="flex items-center gap-2 mt-2 flex-wrap">
                                <label class="text-xs">字号:</label>
                                <input type="number" id="aux-text-size" value="16" class="w-14 border-gray-300 rounded-md shadow-sm text-sm p-1">
                                <label class="text-xs">颜色:</label>
                                <input type="color" id="aux-text-color" value="#374151" class="w-8 h-7 border-none rounded-md p-0">
                             </div>
                        </div>

                        <div class="border-t pt-3">
                             <p class="text-sm font-semibold text-gray-600 mb-1">核心标题</p>
                             <textarea id="title-text-input" rows="3" class="w-full border-gray-300 rounded-md shadow-sm text-sm p-2">定价心理学：5个心理触发因素+优化支付意愿的测试框架</textarea>
                             <div class="flex items-center gap-2 mt-2 flex-wrap">
                                <label class="text-xs">字号:</label>
                                <input type="number" id="title-text-size" value="40" class="w-14 border-gray-300 rounded-md shadow-sm text-sm p-1">
                                <label class="text-xs">颜色:</label>
                                <input type="color" id="title-text-color" value="#111827" class="w-8 h-7 border-none rounded-md p-0">
                             </div>
                        </div>

                        <div class="border-t pt-3">
                             <p class="text-sm font-semibold text-gray-600 mb-1">说明文字</p>
                             <textarea id="description-text-input" rows="2" class="w-full border-gray-300 rounded-md shadow-sm text-sm p-2">掌握5大心理触发，通过价值感知与紧迫感提升客单价67%，实战框架助你快速见效。</textarea>
                             <div class="flex items-center gap-2 mt-2 flex-wrap">
                                <label class="text-xs">字号:</label>
                                <input type="number" id="description-text-size" value="18" class="w-14 border-gray-300 rounded-md shadow-sm text-sm p-1">
                                <label class="text-xs">颜色:</label>
                                <input type="color" id="description-text-color" value="#374151" class="w-8 h-7 border-none rounded-md p-0">
                             </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 背景样式 -->
                <div id="background-controls-container">
                    <h2 class="text-lg font-bold mb-2 text-gray-700">3. 背景样式</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">背景风格</label>
                            <div class="grid grid-cols-2 gap-2 rounded-lg bg-gray-100 p-1">
                                <button id="bg-style-solid" class="bg-style-btn bg-white shadow rounded-md py-1 px-2 text-xs font-semibold text-gray-700">纯色</button>
                                <button id="bg-style-gradient" class="bg-style-btn py-1 px-2 text-xs font-semibold text-gray-500">渐变</button>
                            </div>
                        </div>
                        <div id="solid-color-controls">
                            <label class="text-xs font-medium text-gray-600">背景颜色</label>
                            <div class="flex items-center gap-4 mt-1">
                                <input type="color" id="text-bg-color" value="#ffffff" class="w-full h-8 border-none rounded-md">
                            </div>
                        </div>
                        <div id="gradient-color-controls" class="hidden">
                             <label class="text-xs font-medium text-gray-600">渐变颜色</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="color" id="text-bg-gradient-start" value="#ffffff" class="w-1/2 h-8 border-none rounded-md">
                                <input type="color" id="text-bg-gradient-end" value="#e5e7eb" class="w-1/2 h-8 border-none rounded-md">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. 下载 -->
                <div>
                     <h2 class="text-lg font-bold mb-2 text-gray-700">4. 生成与操作</h2>
                     <div class="space-y-2">
                        <button id="reset-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-gray-600 transition-colors duration-300 flex items-center justify-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                            复位所有设置
                        </button>
                        <button id="download-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            下载封面 (PNG)
                        </button>
                    </div>
                </div>
            </div>

            <!-- 预览画布 -->
            <div class="w-full lg:w-2/3 flex items-center justify-center">
                <div id="canvas-container" class="w-full max-w-lg">
                    <div id="canvas" class="w-full bg-gray-200 shadow-2xl rounded-2xl overflow-hidden template-a">
                        <!-- Canvas content will be dynamically generated here -->
                        <div class="text-container">
                           <p id="aux-text-preview" class="aux-text" style="font-size: 16px; color: #374151; margin-bottom: 1rem; font-family: 'Noto Sans SC', sans-serif;">引言/LOGO</p>
                           <h1 id="title-text-preview" style="font-size: 40px; color: #111827; font-weight: 900; line-height: 1.3; font-family: 'Noto Sans SC', sans-serif;">
                                <span class="title-highlight">定价心理学</span>：5个心理触发因素+优化支付意愿的测试框架
                           </h1>
                           <p id="description-text-preview" class="description-text" style="font-size: 18px; color: #374151; margin-top: 1rem; font-family: 'Noto Sans SC', sans-serif;">掌握5大心理触发，通过价值感知与紧迫感提升客单价67%，实战框架助你快速见效。</p>
                        </div>
                        <div class="image-container">
                            <img id="image-preview" src="https://images.unsplash.com/photo-1543286386-7134a4a491a7?q=80&w=2070&auto=format&fit=crop" alt="预览图片">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 获取所有需要的 DOM 元素 ---
            const canvas = document.getElementById('canvas');
            const templateButtons = document.querySelectorAll('.template-btn');
            const imageUpload = document.getElementById('image-upload');
            const imagePreview = document.getElementById('image-preview');
            const downloadBtn = document.getElementById('download-btn');
            const resetBtn = document.getElementById('reset-btn');
            const bgControlsContainer = document.getElementById('background-controls-container');
            const bgStyleSolidBtn = document.getElementById('bg-style-solid');
            const bgStyleGradientBtn = document.getElementById('bg-style-gradient');
            const solidColorControls = document.getElementById('solid-color-controls');
            const gradientColorControls = document.getElementById('gradient-color-controls');
            const textBgColorInput = document.getElementById('text-bg-color');
            const textBgGradientStartInput = document.getElementById('text-bg-gradient-start');
            const textBgGradientEndInput = document.getElementById('text-bg-gradient-end');
            
            // --- 文本元素映射 ---
            const textElements = {
                aux: {
                    input: document.getElementById('aux-text-input'),
                    size: document.getElementById('aux-text-size'),
                    color: document.getElementById('aux-text-color'),
                    preview: document.getElementById('aux-text-preview'),
                },
                title: {
                    input: document.getElementById('title-text-input'),
                    size: document.getElementById('title-text-size'),
                    color: document.getElementById('title-text-color'),
                    preview: document.getElementById('title-text-preview'),
                },
                description: {
                    input: document.getElementById('description-text-input'),
                    size: document.getElementById('description-text-size'),
                    color: document.getElementById('description-text-color'),
                    preview: document.getElementById('description-text-preview'),
                }
            };

            // --- 状态与变量 ---
            let imageContainer;
            let isDragging = false, startX, startY, initialLeft, initialTop;
            let currentBgStyle = 'solid';

            const DEFAULTS = {
                imageSrc: 'https://images.unsplash.com/photo-1543286386-7134a4a491a7?q=80&w=2070&auto=format&fit=crop',
                auxText: '引言/LOGO', auxTextSize: 16, auxTextColor: '#374151',
                titleText: '定价心理学：5个心理触发因素+优化支付意愿的测试框架', titleTextSize: 40, titleTextColor: '#111827',
                descText: '掌握5大心理触发，通过价值感知与紧迫感提升客单价67%，实战框架助你快速见效。', descTextSize: 18, descTextColor: '#374151',
                bgColor: '#ffffff', gradientStart: '#ffffff', gradientEnd: '#e5e7eb',
            };
            
            // --- 核心功能函数 ---
            function triggerEvent(element, eventName) {
                element.dispatchEvent(new Event(eventName, { bubbles: true }));
            }
            
            // 更新文字背景
            function updateTextContainerBackground() {
                const textContainer = canvas.querySelector('.text-container');
                if (!textContainer) return;
                if (canvas.classList.contains('template-c')) {
                    textContainer.style.background = ''; return;
                }
                if (currentBgStyle === 'solid') {
                    textContainer.style.background = textBgColorInput.value;
                } else {
                    textContainer.style.background = `linear-gradient(135deg, ${textBgGradientStartInput.value}, ${textBgGradientEndInput.value})`;
                }
            }

            // 调整图片尺寸与位置
            function adjustAndPositionImage() {
                imageContainer = imagePreview.parentElement;
                const img = imagePreview, container = imageContainer;
                const { offsetWidth: cW, offsetHeight: cH } = container;
                const { naturalWidth: nW, naturalHeight: nH } = img;

                if (!cW || !cH || !nW || !nH) { requestAnimationFrame(adjustAndPositionImage); return; }

                const cRatio = cW / cH, iRatio = nW / nH;
                let newWidth, newHeight;
                if (iRatio > cRatio) { newHeight = cH; newWidth = newHeight * iRatio; } 
                else { newWidth = cW; newHeight = newWidth / iRatio; }

                img.style.width = `${newWidth}px`;
                img.style.height = `${newHeight}px`;
                img.style.left = `${(cW - newWidth) / 2}px`;
                img.style.top = `${(cH - newHeight) / 2}px`;
            }
            
            // --- 事件处理函数 ---
            function onMouseDown(e) {
                e.preventDefault(); isDragging = true;
                imageContainer = imagePreview.parentElement;
                imageContainer.style.cursor = 'grabbing';
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                startY = e.touches ? e.touches[0].clientY : e.clientY;
                initialLeft = imagePreview.offsetLeft;
                initialTop = imagePreview.offsetTop;
                window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp);
                window.addEventListener('touchmove', onMouseMove); window.addEventListener('touchend', onMouseUp);
            }
            function onMouseMove(e) {
                if (!isDragging) return;
                const currentX = e.touches ? e.touches[0].clientX : e.clientX;
                const currentY = e.touches ? e.touches[0].clientY : e.clientY;
                const dx = currentX - startX, dy = currentY - startY;
                let newLeft = initialLeft + dx, newTop = initialTop + dy;
                const { offsetWidth: cW, offsetHeight: cH } = imageContainer;
                const { offsetWidth: iW, offsetHeight: iH } = imagePreview;
                if (newLeft > 0) newLeft = 0; if (newTop > 0) newTop = 0;
                if (newLeft < cW - iW) newLeft = cW - iW;
                if (newTop < cH - iH) newTop = cH - iH;
                imagePreview.style.left = `${newLeft}px`;
                imagePreview.style.top = `${newTop}px`;
            }
            function onMouseUp() {
                isDragging = false;
                imageContainer.style.cursor = 'grab';
                window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp);
                window.removeEventListener('touchmove', onMouseMove); window.removeEventListener('touchend', onMouseUp);
            }

            // --- 事件绑定 ---
            // 模板切换
            templateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedTemplate = button.dataset.template;
                    canvas.className = canvas.className.replace(/template-\w+/g, '');
                    canvas.classList.add(selectedTemplate);
                    templateButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    button.classList.add('bg-blue-500', 'text-white');
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                    bgControlsContainer.style.display = selectedTemplate === 'template-c' ? 'none' : 'block';
                    
                    if (selectedTemplate === 'template-c') {
                        textElements.aux.color.value = '#FFFFFF';
                        textElements.title.color.value = '#FFFFFF';
                        textElements.description.color.value = '#FFFFFF';
                    } else if (selectedTemplate === 'template-d') {
                         textElements.aux.color.value = '#9ca3af';
                         textElements.title.color.value = '#FFFFFF';
                         textElements.description.color.value = '#d1d5db';
                    } else {
                        textElements.aux.color.value = DEFAULTS.auxTextColor;
                        textElements.title.color.value = DEFAULTS.titleTextColor;
                        textElements.description.color.value = DEFAULTS.descTextColor;
                    }
                    
                    // Trigger color updates
                    Object.values(textElements).forEach(el => {
                        triggerEvent(el.color, 'input');
                    });

                    if (selectedTemplate === 'template-a') textBgColorInput.value = '#ffffff';
                    if (selectedTemplate === 'template-b') textBgColorInput.value = '#f0fdf4';
                    if (selectedTemplate === 'template-d') textBgColorInput.value = '#1f2937';
                    
                    updateTextContainerBackground();
                    requestAnimationFrame(adjustAndPositionImage);
                });
            });

            // 图片上传
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => imagePreview.src = e.target.result;
                    reader.readAsDataURL(file);
                }
            });
            imagePreview.addEventListener('load', adjustAndPositionImage);
            imagePreview.addEventListener('mousedown', onMouseDown);
            imagePreview.addEventListener('touchstart', onMouseDown);

            // 文本和样式更新
            Object.values(textElements).forEach(el => {
                el.input.addEventListener('input', () => {
                    if (el === textElements.title) {
                        const lines = el.input.value.split('：');
                        el.preview.innerHTML = lines.length > 1 ? `<span class="title-highlight">${lines[0]}</span>：${lines.slice(1).join('：')}` : `<span class="title-highlight">${el.input.value}</span>`;
                    } else {
                        el.preview.textContent = el.input.value;
                    }
                });
                el.size.addEventListener('input', () => el.preview.style.fontSize = `${el.size.value}px`);
                el.color.addEventListener('input', () => el.preview.style.color = el.color.value);
            });

            // 背景样式更新
            bgStyleSolidBtn.addEventListener('click', () => {
                currentBgStyle = 'solid';
                solidColorControls.classList.remove('hidden'); gradientColorControls.classList.add('hidden');
                bgStyleSolidBtn.classList.add('bg-white', 'shadow'); bgStyleGradientBtn.classList.remove('bg-white', 'shadow');
                updateTextContainerBackground();
            });
            bgStyleGradientBtn.addEventListener('click', () => {
                currentBgStyle = 'gradient';
                solidColorControls.classList.add('hidden'); gradientColorControls.classList.remove('hidden');
                bgStyleGradientBtn.classList.add('bg-white', 'shadow'); bgStyleSolidBtn.classList.remove('bg-white', 'shadow');
                updateTextContainerBackground();
            });
            [textBgColorInput, textBgGradientStartInput, textBgGradientEndInput].forEach(input => {
                input.addEventListener('input', updateTextContainerBackground);
            });
            
            // 下载功能
            downloadBtn.addEventListener('click', () => {
                // 确保元素在视口中以获得最佳截图效果
                window.scrollTo(0, 0);

                // 等待字体加载完成
                document.fonts.ready.then(function () {
                    html2canvas(canvas, { 
                        scale: 1080 / canvas.offsetWidth, 
                        useCORS: true, 
                        logging: false,
                        backgroundColor: null // 修复圆角问题
                    })
                        .then(generatedCanvas => {
                            const link = document.createElement('a');
                            link.download = `xiaohongshu_cover_${Date.now()}.png`;
                            link.href = generatedCanvas.toDataURL('image/png');
                            link.click();
                        });
                });
            });

            // 复位功能
            resetBtn.addEventListener('click', () => {
                textElements.aux.input.value = DEFAULTS.auxText;
                textElements.title.input.value = DEFAULTS.titleText;
                textElements.description.input.value = DEFAULTS.descText;
                textElements.aux.size.value = DEFAULTS.auxTextSize; textElements.aux.color.value = DEFAULTS.auxTextColor;
                textElements.title.size.value = DEFAULTS.titleTextSize; textElements.title.color.value = DEFAULTS.titleTextColor;
                textElements.description.size.value = DEFAULTS.descTextSize; textElements.description.color.value = DEFAULTS.descTextColor;
                
                currentBgStyle = 'solid';
                textBgColorInput.value = DEFAULTS.bgColor;
                textBgGradientStartInput.value = DEFAULTS.gradientStart;
                textBgGradientEndInput.value = DEFAULTS.gradientEnd;

                Object.values(textElements).forEach(el => {
                    triggerEvent(el.input, 'input'); triggerEvent(el.size, 'input');
                    triggerEvent(el.color, 'input');
                });
                triggerEvent(bgStyleSolidBtn, 'click');

                imagePreview.src = DEFAULTS.imageSrc;
                triggerEvent(document.querySelector('.template-btn[data-template="template-a"]'), 'click');
            });
            
            // --- 初始化 ---
            updateTextContainerBackground();
        });
    </script>
</body>
</html>

